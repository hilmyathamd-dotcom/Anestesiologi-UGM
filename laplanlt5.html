<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Jadwal Operasi Elektif (TSV to WhatsApp)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 { font-size: 1.2rem; margin-bottom: 15px; }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            white-space: pre;
            overflow-x: auto;
        }
        input[type="date"], input[type="file"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        
        #output-area {
            margin-top: 20px;
            position: relative;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            border: 1px solid #ddd;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .guide {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Generator Jadwal Operasi Elektif (TSV Mode)</h1>

    <div class="guide">
        <strong>Instruksi:</strong> Paste data TSV (dari Excel/Spreadsheet) ke dalam kotak di bawah, atau upload file .tsv/.txt. Pastikan kolom data mencakup: Nama, L/P, Usia, Ruang, Diagnosis, Tindakan, OK, Jam.
    </div>

    <div class="input-group">
        <label for="dateInput">Tanggal Operasi:</label>
        <input type="date" id="dateInput">
    </div>

    <div class="input-group">
        <label for="fileInput">Upload File TSV (Opsional):</label>
        <input type="file" id="fileInput" accept=".tsv,.txt,.csv">
    </div>

    <div class="input-group">
        <label for="tsvInput">Data TSV:</label>
        <textarea id="tsvInput" placeholder="Paste data TSV di sini..."></textarea>
    </div>

    <button onclick="processTSV()">Proses Data</button>
    <button class="secondary" onclick="clearAll()">Reset</button>

    <div id="output-area" style="display:none;">
        <h3>Hasil (WhatsApp Format):</h3>
        <button class="copy-btn" onclick="copyOutput()">Copy Text</button>
        <pre id="resultOutput"></pre>
    </div>
</div>

<script>
    // --- Constants & Config ---
    const VIP_CODES = ['AYD', 'AMT', 'CW', 'ALMT', 'ALM-T', 'IP1', 'IP5', 'MATN', 'MAT-N'];
    const ROOM_MAPPING = {
        'GK4MH': 'GK4MC',
        'NICK': 'NICU',
        'KESAWA': 'KSW',
        'WISNU': 'WSM',
        'AST-T': 'ASTT',
        'AST-B': 'ASTB',
        'MANK': 'MATK' // Assuming correction based on context or leave if not specified
    };
    
    // Abbreviations to keep UPPERCASE
    const ABBREVIATIONS = ['ASA', 'AV', 'ORIF', 'CRIF', 'CKD', 'PLIF', 'B20', 'HBSAG', 'HIV', 'TB', 'TKR', 'THR', 'IF', 'CF', 'PS', 'RA', 'GA', 'LA', 'CVC', 'CDL'];
    // Words to keep lowercase
    const LOWERCASE_EXCEPTIONS = ['ec', 'et', 'of', 'to', 'at', 'in', 'on', 'via'];

    // --- Event Listeners ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('tsvInput').value = e.target.result;
        };
        reader.readAsText(file);
    });

    // --- Core Processing Logic ---
    function processTSV() {
        const rawText = document.getElementById('tsvInput').value;
        const dateVal = document.getElementById('dateInput').value;

        if (!rawText.trim()) {
            alert("Mohon masukkan data TSV.");
            return;
        }

        const lines = rawText.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 1) return;

        // 1. Parse Header to find Column Indices
        const header = lines[0].toLowerCase().split('\t');
        const colMap = mapColumns(header);
        
        // If header detection fails (e.g., direct data), assume standard structure or warn?
        // Let's fallback to standard indices if keys not found, but trying to be smart.
        // Standard assumption if headers missing: 0:No, 1:Nama, 2:LP, 3:Usia, 4:Ruang, 5:Diag, 6:Plan, 7:OK, 8:Jam
        
        const patients = [];
        let startIndex = 1; // Skip header
        
        // If line 0 doesn't look like a header (e.g. contains numbers/dates in name col), process it too
        if (colMap.score < 2) { 
             startIndex = 0; // Treat first line as data
             // Default mapping fallback
             colMap.idxs = { name: 1, sex: 2, age: 3, room: 4, diag: 5, proc: 6, ok: 7, time: 8 };
        }

        // 2. Extract Data
        for (let i = startIndex; i < lines.length; i++) {
            const cols = lines[i].split('\t');
            // Safe access
            const getCol = (idx) => (cols[idx] || '').trim();
            
            // Critical check: Skip if name is empty
            const nameRaw = getCol(colMap.idxs.name);
            if (!nameRaw) continue;

            const p = {
                name: nameRaw,
                sex: getCol(colMap.idxs.sex),
                age: getCol(colMap.idxs.age),
                room: getCol(colMap.idxs.room),
                diag: getCol(colMap.idxs.diag),
                proc: getCol(colMap.idxs.proc),
                ok: getCol(colMap.idxs.ok),
                time: getCol(colMap.idxs.time),
                origRow: i
            };

            // Normalize OK room (extract number like "5.01")
            const okMatch = p.ok.match(/5\.0[1-6]/);
            p.okClean = okMatch ? okMatch[0] : 'Unknown';

            // Only process valid OK rooms for the template
            if (['5.01','5.02','5.03','5.04','5.05','5.06'].includes(p.okClean)) {
                patients.push(processPatientData(p));
            }
        }

        // 3. Generate Output
        const output = generateTemplate(patients, dateVal);
        document.getElementById('resultOutput').textContent = output;
        document.getElementById('output-area').style.display = 'block';
    }

    function mapColumns(headerCols) {
        const map = { name: -1, sex: -1, age: -1, room: -1, diag: -1, proc: -1, ok: -1, time: -1 };
        let score = 0;

        headerCols.forEach((col, idx) => {
            const c = col.trim();
            if (c.includes('nama')) { map.name = idx; score++; }
            else if (c === 'l/p' || c.includes('sex') || c.includes('jen') || c.includes('kelamin')) { map.sex = idx; score++; }
            else if (c.includes('usi') || c.includes('umur')) { map.age = idx; score++; }
            else if (c.includes('ruang') || c.includes('sal')) { map.room = idx; score++; }
            else if (c.includes('diag')) { map.diag = idx; score++; }
            else if (c.includes('tindakan') || c.includes('operasi') || c.includes('rencana')) { map.proc = idx; score++; }
            else if (c === 'ok' || c.includes('kamar ok')) { map.ok = idx; score++; }
            else if (c.includes('jam') || c.includes('waktu')) { map.time = idx; score++; }
        });
        
        return { idxs: map, score: score };
    }

    function processPatientData(p) {
        // --- Normalization Logic ---

        // 1. Diagnosis
        let diag = p.diag;
        // Replace connectors
        diag = diag.replace(/\s+\+\s+/g, ', ');
        diag = diag.replace(/\s+dan\s+/gi, ', ');
        diag = diag.replace(/\s+dengan\s+/gi, ', ');
        // Remove specific words (replace with comma as per prompt, effectively removing context usually)
        // Prompt: "Jika terdapat kata ... MAKA HAPUS seluruh bagian tersebut diganti dengan , koma"
        // Interpretation: Replace the word 'Pro' or 'Stadium' with ',' and clean up.
        diag = diag.replace(/\b(Pro\.?|Stadium|Metastasis)\b/gi, ','); 
        // Clean up double commas or leading/trailing commas
        diag = diag.replace(/,+/g, ',').replace(/^,/, '').replace(/,$/, '').trim();
        // Title Case
        diag = toTitleCase(diag);

        // 2. Room Code
        let room = p.room.toUpperCase();
        // Remove dashes
        room = room.replace(/-/g, '');
        // Map specific codes
        Object.keys(ROOM_MAPPING).forEach(key => {
            if (room.includes(key.replace(/-/g, ''))) { // Compare normalized key
               room = room.replace(key.replace(/-/g, ''), ROOM_MAPPING[key]); 
            }
        });
        // Check raw mapping (if mapping key had dashes removed)
        if (room === 'GK4MH') room = 'GK4MC'; // Explicit backup based on prompt

        // 3. Time & VIP
        let time = p.time.replace('Jam', '').replace(':', '.').trim();
        // Ensure HH.MM format if possible
        if (time.length === 4 && !time.includes('.')) time = time.substring(0,2) + '.' + time.substring(2);
        
        let isVip = false;
        // Check VIP codes in Room
        const vipCheck = [...VIP_CODES].map(c => c.replace(/-/g, '')); // Normalize VIP list too
        if (vipCheck.some(v => room.includes(v))) isVip = true;
        
        // Check keywords in Diagnosis (HbsAg, B20)
        if (/HbsAg|B20/i.test(p.diag)) isVip = true;

        // Add VIP tag
        let displayTime = time;
        if (!displayTime) displayTime = "Jam ";
        if (isVip) {
            displayTime = `${displayTime} *VIP*`;
        }

        // 4. Age
        // Ensure unit is present. If just number, assume 'th'
        let age = p.age.trim();
        if (/^\d+$/.test(age)) age += " th";

        // 5. Gender
        let gender = p.sex.trim().toUpperCase().charAt(0); // L or P

        return {
            raw: p,
            okGroup: p.okClean,
            name: p.name, // Keep Name Case? Prompt doesn't specify name casing, implied Keep As Is or Title Case. Usually names are Title Case.
            gender: gender,
            age: age,
            room: room,
            diagnosis: diag,
            procedure: p.proc, // Keep case or title? Prompt says "Tanda + diganti koma" applies generally. Let's strict clean Proc too? Usually Proc is mixed. I will apply basic cleanup but not strict title case on procedure unless requested. Prompt normalizes Diagnosis specifically.
            timeDisplay: displayTime,
            isVip: isVip
        };
    }

    function toTitleCase(str) {
        return str.split(/[\s,]+/).map((word, index) => {
            const cleanWord = word.replace(/[^a-zA-Z0-9]/g, ''); // strip punctuation for check
            const upper = cleanWord.toUpperCase();
            const lower = cleanWord.toLowerCase();

            // Retain special chars in the original word (like parentheses)
            // Strategy: Reconstruct word.

            // Check abbreviation list
            if (ABBREVIATIONS.includes(upper)) return word.toUpperCase();
            
            // Check lowercase list
            if (index > 0 && LOWERCASE_EXCEPTIONS.includes(lower)) return word.toLowerCase();

            // Default Title Case
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }).join(' ').replace(/\s+,/g, ','); // fix spaces before commas
    }

    function generateTemplate(patients, dateRaw) {
        // Date Formatting
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        let dateStr = "________, ___ __________ 20";
        if (dateRaw) {
            const d = new Date(dateRaw);
            const dayName = days[d.getDay()];
            const dayDate = d.getDate();
            const monthName = months[d.getMonth()];
            const yearFull = d.getFullYear().toString();
            dateStr = `${dayName}, ${dayDate} ${monthName} ${yearFull}`;
        }

        // Aggregation
        let count501_503 = 0;
        let count504_506 = 0;
        let countVIP = 0;

        const groups = {
            '5.01': [], '5.02': [], '5.03': [], '5.04': [], '5.05': [], '5.06': []
        };

        patients.forEach(p => {
            if (groups[p.okGroup]) {
                groups[p.okGroup].push(p);
                
                // Count totals
                if (['5.01','5.02','5.03'].includes(p.okGroup)) count501_503++;
                if (['5.04','5.05','5.06'].includes(p.okGroup)) count504_506++;
                
                if (p.isVip) countVIP++;
            }
        });

        // Build Text
        let txt = `Assalamu’alaikum Wr Wb.\n`;
        txt += `Selamat Malam Dokter, Mohon Izin Menyampaikan Rencana Operasi ELEKTIF.\n\n`;
        txt += `*Lantai 5 ${dateStr}*\n\n`;
        txt += `Jumlah pasien ACC : \n`;
        txt += `Jumlah pasien BATAL : \n`;
        txt += `Jumlah pasien operasi : \n\n`;
        txt += `Jumlah pasien VIP : ${countVIP > 0 ? countVIP : ''}\n`;
        txt += `Jumlah pasien bermasalah : \n`;
        txt += `Jumlah pasien KUM/Pengayaan : \n\n`;
        txt += `Total pasien 5.01–5.03 : ${count501_503}\n`;
        txt += `Total pasien 5.04–5.06 : ${count504_506}\n\n`;
        txt += `Pasien Bermasalah\n\n`;
        txt += `====================\n\n`;
        txt += `*Rekap Seluruh Pasien*\n\n`;

        // Loop Rooms
        ['5.01', '5.02', '5.03', '5.04', '5.05', '5.06'].forEach(room => {
            txt += `*${room}*\n`;
            const list = groups[room];
            if (list.length === 0) {
                // Should we print blank structure or nothing? 
                // Template implies structure exists. If no patient, just header?
                // "Spasi antar pasien CUKUP 1 BARIS". If empty, maybe just header.
                // Leaving empty for now as per "rekap seluruh pasien" usually lists data. 
                // However, template shows the structure. I will leave it empty if 0 patients, 
                // BUT strictly following the template might imply printing the block logic.
                // Let's print nothing under the header if empty to be safe, or just the header.
            } else {
                list.forEach(p => {
                    txt += `{${p.timeDisplay}} \n`;
                    txt += `(${p.name})/(${p.gender})/(${p.age})/(${p.room})/(${p.diagnosis})/(${p.procedure})  \n`;
                    txt += `ASA : \n`;
                    txt += `PLAN : \n`;
                    txt += `KAMAR : \n`;
                    txt += `TIM : \n`;
                    txt += `_Problem_ : \n\n`;
                });
            }
        });

        txt += `Terima Kasih\nChief Lantai`;
        
        return txt;
    }

    function clearAll() {
        document.getElementById('tsvInput').value = '';
        document.getElementById('dateInput').value = '';
        document.getElementById('fileInput').value = '';
        document.getElementById('output-area').style.display = 'none';
        document.getElementById('resultOutput').textContent = '';
    }

    function copyOutput() {
        const text = document.getElementById('resultOutput').textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('Teks berhasil disalin!');
        });
    }

</script>

</body>
</html>
