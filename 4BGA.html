<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced BGA Interpreter & Calculator</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text-main); padding: 20px; line-height: 1.5; }
        
        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } }

        /* Cards */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        
        h1 { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 1rem; border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; }
        h3 { font-size: 0.95rem; font-weight: 600; color: var(--text-muted); margin-top: 1rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Input Styles */
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted); }
        input[type="number"], textarea, select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; transition: border-color 0.2s; }
        input[type="number"]:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; ring: 2px solid var(--primary); }
        textarea { height: 120px; font-family: monospace; font-size: 0.85rem; resize: vertical; }

        /* Grid for Manual Inputs */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        
        /* Toggles */
        .toggle-group { display: flex; gap: 10px; margin-bottom: 15px; background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .radio-label { flex: 1; text-align: center; cursor: pointer; padding: 6px; border-radius: 4px; font-size: 0.9rem; font-weight: 600; user-select: none; transition: all 0.2s; border: 1px solid transparent; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: var(--primary); color: white; shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Buttons */
        .btn { width: 100%; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 8px; transition: background 0.2s; }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: #eff6ff; }

        /* Results */
        .result-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
        .result-row:last-child { border-bottom: none; }
        .result-val { font-weight: 700; font-family: monospace; }
        
        .interp-box { background: #eff6ff; border-left: 4px solid var(--primary); padding: 15px; margin-top: 10px; border-radius: 4px; }
        .interp-box.danger { background: #fef2f2; border-left-color: var(--danger); }
        .interp-box.warning { background: #fffbeb; border-left-color: var(--warning); }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; color: white; margin-left: 8px; }
        .badge.acid { background: var(--warning); }
        .badge.alk { background: var(--primary); }
        .badge.normal { background: var(--success); }

        /* Mnemonics Accordion */
        details { border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
        summary { background: #f9fafb; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.9rem; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        summary::after { content: '+'; font-size: 1.2rem; }
        details[open] summary::after { content: '-'; }
        .details-content { padding: 15px; font-size: 0.85rem; background: white; border-top: 1px solid var(--border); }
        .details-content ul { padding-left: 20px; }
        .details-content li { margin-bottom: 4px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card full-width">
        <h1>BGA Interpreter & Calculator</h1>
        
        <div class="toggle-group">
            <label style="flex:0.3; align-self:center; margin:0;">Disorder Timing:</label>
            <label class="radio-label">
                <input type="radio" name="timing" value="acute" checked onchange="calculate()">
                Acute
            </label>
            <label class="radio-label">
                <input type="radio" name="timing" value="chronic" onchange="calculate()">
                Chronic
            </label>
        </div>

        <label>Smart Data Parser</label>
        <textarea id="pasteArea" placeholder="Paste BGA results here (e.g., from format: pH 7.495 pCO2 42.6 ...). 
The calculator will try to automatically extract values."></textarea>
        <button class="btn btn-outline" onclick="parseData()">Extract Data</button>
    </div>

    <div class="card">
        <h2>Input Parameters</h2>
        <div class="input-grid">
            <div>
                <label>pH</label>
                <input type="number" id="ph" step="0.01" placeholder="7.40" oninput="calculate()">
            </div>
            <div>
                <label>PaCO₂ (mmHg)</label>
                <input type="number" id="pco2" step="0.1" placeholder="40" oninput="calculate()">
            </div>
            <div>
                <label>HCO₃⁻ (mEq/L)</label>
                <input type="number" id="hco3" step="0.1" placeholder="24" oninput="calculate()">
            </div>
            <div>
                <label>PaO₂ (mmHg)</label>
                <input type="number" id="po2" step="0.1" placeholder="95" oninput="calculate()">
            </div>
            <div>
                <label>FiO₂ (0.21-1.0)</label>
                <input type="number" id="fio2" step="0.01" placeholder="0.21" oninput="calculate()">
            </div>
            <div>
                <label>Lactate</label>
                <input type="number" id="lac" step="0.1" placeholder="1.0" oninput="calculate()">
            </div>
            <div>
                <label>BE</label>
                <input type="number" id="be" step="0.1" placeholder="0" oninput="calculate()">
            </div>
        </div>

        <h3>Electrolytes (For Anion Gap)</h3>
        <div class="input-grid">
            <div>
                <label>Na⁺</label>
                <input type="number" id="na" step="1" placeholder="140" oninput="calculate()">
            </div>
            <div>
                <label>Cl⁻</label>
                <input type="number" id="cl" step="1" placeholder="100" oninput="calculate()">
            </div>
            <div>
                <label>K⁺ (Optional)</label>
                <input type="number" id="k" step="0.1" placeholder="4.0" oninput="calculate()">
            </div>
            <div style="grid-column: span 2;">
                <label>Albumin (g/dL)</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="albumin" step="0.1" value="4.0" oninput="calculate()">
                    <span style="font-size:0.7rem; color:gray; align-self:center;">(Default 4.0)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Interpretation</h2>
        
        <div id="primaryInterp" class="interp-box">
            Waiting for data...
        </div>

        <h3>Compensation Analysis</h3>
        <div id="compInterp" class="result-row" style="display:block; font-style: italic; color: #555;">-</div>

        <div id="agSection" class="hidden">
            <h3>Metabolic Analysis (HAGMA)</h3>
            <div class="result-row">
                <span>Anion Gap (Calc):</span>
                <span id="resAG" class="result-val">-</span>
            </div>
            <div class="result-row" id="rowCorrectedAG">
                <span>Corrected AG (Albumin):</span>
                <span id="resCorrAG" class="result-val">-</span>
            </div>
            <div class="result-row" id="rowDelta">
                <span>Delta Ratio:</span>
                <span id="resDelta" class="result-val">-</span>
            </div>
            <div id="deltaInterp" class="interp-box warning" style="margin-top:5px; font-size: 0.9rem;"></div>
        </div>

        <h3>Derived Values</h3>
        <div class="result-row"><span>PF Ratio (PaO₂/FiO₂):</span> <span id="resPF" class="result-val">-</span></div>
        <div class="result-row"><span>Base Excess:</span> <span id="resBE" class="result-val">-</span></div>
    </div>

    <div class="card full-width">
        <h2>Differential Diagnosis Reference</h2>
        
        <details>
            <summary>HAGMA (High Anion Gap) - MUDPILES</summary>
            <div class="details-content">
                <strong>CAT MUDPILES</strong>
                <ul>
                    <li><strong>C</strong>: CO, Cyanide, Congenital Heart Failure</li>
                    <li><strong>A</strong>: Aminoglycosides, Arsenic</li>
                    <li><strong>T</strong>: Theophylline, Toluene</li>
                    <li><strong>M</strong>: Methanol</li>
                    <li><strong>U</strong>: Uremia (Renal Failure)</li>
                    <li><strong>D</strong>: DKA, AKA, Starvation Ketoacidosis</li>
                    <li><strong>P</strong>: Paracetamol, Phenformin</li>
                    <li><strong>I</strong>: Iron, Isoniazid</li>
                    <li><strong>L</strong>: Lactic Acidosis</li>
                    <li><strong>E</strong>: Ethanol, Ethylene Glycol</li>
                    <li><strong>S</strong>: Salicylates (Aspirin)</li>
                </ul>
            </div>
        </details>

        <details>
            <summary>NAGMA (Normal Anion Gap) - USED CARP</summary>
            <div class="details-content">
                <strong>USED CARP</strong>
                <ul>
                    <li><strong>U</strong>: Uretero-sigmoidostomy</li>
                    <li><strong>S</strong>: Saline (Hyperchloremic acidosis)</li>
                    <li><strong>E</strong>: Endocrine (Addison’s, Hyperparathyroid)</li>
                    <li><strong>D</strong>: Diarrhea / GI Losses</li>
                    <li><strong>C</strong>: Carbonic Anhydrase Inhibitors (Acetazolamide)</li>
                    <li><strong>A</strong>: Ammonium Chloride / TPN</li>
                    <li><strong>R</strong>: Renal Tubular Acidosis (RTA)</li>
                    <li><strong>P</strong>: Pancreatic Fistula</li>
                </ul>
            </div>
        </details>
    </div>
</div>

<script>
    // --- Data Extraction Logic ---
    function parseData() {
        const text = document.getElementById('pasteArea').value;
        if (!text) return;

        // Helper for regex matching
        const findVal = (regex) => {
            const match = text.match(regex);
            return match ? match[1] : null;
        };

        // Regex patterns based on common BGA machine outputs and user format
        const patterns = {
            ph: /pH(?:.*?)(\d+\.\d+)/i,
            pco2: /(?:pCO2|PCO2)(?:.*?)(\d+\.\d+)/i,
            // Prioritize standard/chemical bicarbonate if distinct labels exist, otherwise broad match
            hco3: /(?:cHCO3|HCO3|Bicarbonate).*?(?:\(st\)|\(P\))?\s*(\d+\.\d+)/i,
            po2: /(?:pO2|PO2)(?!\/)(?:.*?)(\d+\.\d+)/i, // exclude PO2/FiO2 ratios
            fio2: /FIO2(?:.*?)(\d+(?:\.\d+)?)/i,
            na: /(?:Na|Natrium)\+?(?:.*?)(\d+\.?\d*)/i,
            k: /(?:K|Kalium)\+?(?:.*?)(\d+\.?\d*)/i,
            cl: /(?:Cl|Chloride)\-?(?:.*?)(\d+\.?\d*)/i,
            lac: /(?:Lac|Lactate)(?:.*?)(\d+\.?\d*)/i,
            be: /(?:BE|Base Excess).*?([+-]?\d+\.?\d*)/i,
            alb: /(?:Alb|Albumin)(?:.*?)(\d+\.?\d*)/i
        };

        // Map found values to inputs
        const mappings = {
            'ph': patterns.ph,
            'pco2': patterns.pco2,
            'hco3': patterns.hco3,
            'po2': patterns.po2,
            'fio2': patterns.fio2,
            'na': patterns.na,
            'k': patterns.k,
            'cl': patterns.cl,
            'lac': patterns.lac,
            'be': patterns.be,
            'albumin': patterns.alb
        };

        for (const [id, regex] of Object.entries(mappings)) {
            const val = findVal(regex);
            if (val) {
                // FiO2 specific handling: if > 1 (e.g., 35), convert to decimal (0.35)
                if (id === 'fio2' && parseFloat(val) > 1.0) {
                    document.getElementById(id).value = (parseFloat(val) / 100).toFixed(2);
                } else {
                    document.getElementById(id).value = val;
                }
            }
        }

        // Trigger calc
        calculate();
    }

    // --- Calculation Logic ---
    function calculate() {
        // 1. Get Values
        const getVal = (id) => parseFloat(document.getElementById(id).value);
        const pH = getVal('ph');
        const PaCO2 = getVal('pco2');
        const HCO3 = getVal('hco3');
        const PaO2 = getVal('po2');
        const FiO2 = getVal('fio2');
        const Lac = getVal('lac');
        const BE = getVal('be');
        const Na = getVal('na');
        const Cl = getVal('cl');
        const K = getVal('k');
        let Alb = getVal('albumin');
        
        // Settings
        const timing = document.querySelector('input[name="timing"]:checked').value; // acute/chronic
        if (isNaN(Alb)) Alb = 4.0; // Default normal

        // DOM Elements
        const elPrimary = document.getElementById('primaryInterp');
        const elComp = document.getElementById('compInterp');
        const elAGSec = document.getElementById('agSection');
        const elPF = document.getElementById('resPF');
        const elBE = document.getElementById('resBE');

        // Basic Display Updates
        elBE.innerText = isNaN(BE) ? '-' : BE;
        if (!isNaN(PaO2) && !isNaN(FiO2) && FiO2 > 0) {
            elPF.innerText = (PaO2 / FiO2).toFixed(0) + " mmHg";
        } else {
            elPF.innerText = "-";
        }

        if (isNaN(pH) || isNaN(PaCO2) || isNaN(HCO3)) {
            elPrimary.innerHTML = "Please enter pH, PaCO2, and HCO3.";
            return;
        }

        // 2. Step 1 & 2: Primary Disorder
        let primary = "";
        let acidity = "";
        let details = [];

        // Determine pH Status
        if (pH < 7.35) acidity = "Acidemia";
        else if (pH > 7.45) acidity = "Alkalemia";
        else acidity = "Normal pH";

        // Determine Disorders
        let isMetAcid = (HCO3 < 22);
        let isMetAlk = (HCO3 > 26);
        let isRespAcid = (PaCO2 > 45);
        let isRespAlk = (PaCO2 < 35);

        // Identify Primary Driver
        if (pH < 7.35) {
            // Acidosis
            if (isRespAcid && isMetAcid) primary = "Mixed Respiratory & Metabolic Acidosis";
            else if (isRespAcid) primary = "Respiratory Acidosis";
            else if (isMetAcid) primary = "Metabolic Acidosis";
            else primary = "Acidemia (Unclear origin/Normal values mismatch)";
        } else if (pH > 7.45) {
            // Alkalosis
            if (isRespAlk && isMetAlk) primary = "Mixed Respiratory & Metabolic Alkalosis";
            else if (isRespAlk) primary = "Respiratory Alkalosis";
            else if (isMetAlk) primary = "Metabolic Alkalosis";
            else primary = "Alkalemia (Unclear origin/Normal values mismatch)";
        } else {
            // Normal pH but potentially mixed
            if (isRespAcid && isMetAlk) primary = "Compensated Respiratory Acidosis or Metabolic Alkalosis (Mixed)";
            else if (isRespAlk && isMetAcid) primary = "Compensated Respiratory Alkalosis or Metabolic Acidosis (Mixed)";
            else primary = "Normal Acid-Base Status";
        }

        elPrimary.innerHTML = `<strong>${acidity}</strong>: ${primary}`;
        if (acidity === "Acidemia") elPrimary.className = "interp-box danger";
        else if (acidity === "Alkalemia") elPrimary.className = "interp-box warning";
        else elPrimary.className = "interp-box";

        // 3. Step 3: Compensation Logic
        let compMsg = "";
        
        // A. Metabolic Acidosis (Winter's)
        if (isMetAcid && !isRespAcid && !isRespAlk) { // Pure Met Acid context for Winters
            const expCO2 = (1.5 * HCO3) + 8;
            const minCO2 = expCO2 - 2;
            const maxCO2 = expCO2 + 2;
            
            compMsg = `Winter's Formula (Exp PaCO₂: ${minCO2.toFixed(1)}-${maxCO2.toFixed(1)}): `;
            if (PaCO2 < minCO2) compMsg += "Concomitant Respiratory Alkalosis.";
            else if (PaCO2 > maxCO2) compMsg += "Concomitant Respiratory Acidosis.";
            else compMsg += "Adequate Respiratory Compensation.";
        }
        // B. Metabolic Alkalosis
        else if (isMetAlk && !isRespAcid && !isRespAlk) {
            const expCO2 = 40 + (0.7 * (HCO3 - 24));
            // Usually +/- 2 range
            compMsg = `Expected PaCO₂ (~${expCO2.toFixed(1)}): `;
            if (PaCO2 > expCO2 + 5) compMsg += "Concomitant Respiratory Acidosis likely.";
            else if (PaCO2 < expCO2 - 5) compMsg += "Concomitant Respiratory Alkalosis likely.";
            else compMsg += "Adequate Respiratory Compensation.";
        }
        // C. Respiratory Acidosis
        else if (isRespAcid && !isMetAcid && !isMetAlk) {
            let expHCO3 = 0;
            if (timing === 'acute') expHCO3 = 24 + ((PaCO2 - 40) / 10);
            else expHCO3 = 24 + 4 * ((PaCO2 - 40) / 10);
            
            compMsg = `Exp HCO₃ (${timing}): ${expHCO3.toFixed(1)}. `;
            if (Math.abs(HCO3 - expHCO3) < 3) compMsg += "Compensated as expected.";
            else if (HCO3 < expHCO3) compMsg += "Concomitant Metabolic Acidosis.";
            else compMsg += "Concomitant Metabolic Alkalosis.";
        }
        // D. Respiratory Alkalosis
        else if (isRespAlk && !isMetAcid && !isMetAlk) {
            let expHCO3 = 0;
            if (timing === 'acute') expHCO3 = 24 - 2 * ((40 - PaCO2) / 10);
            else expHCO3 = 24 - 5 * ((40 - PaCO2) / 10);

            compMsg = `Exp HCO₃ (${timing}): ${expHCO3.toFixed(1)}. `;
            if (Math.abs(HCO3 - expHCO3) < 3) compMsg += "Compensated as expected.";
            else if (HCO3 < expHCO3) compMsg += "Concomitant Metabolic Acidosis.";
            else compMsg += "Concomitant Metabolic Alkalosis.";
        }

        elComp.innerHTML = compMsg || "Assessment dependent on primary disorder identification.";

        // 4. Step 4 & 5: Anion Gap & Delta Ratio
        // Always calculate AG if electrolytes present
        if (!isNaN(Na) && !isNaN(Cl)) {
            elAGSec.classList.remove('hidden');
            
            // Calc AG
            const AG = Na - (Cl + HCO3);
            document.getElementById('resAG').innerText = AG.toFixed(1);

            // Corrected AG
            // Correction: For every 1g/dL drop below 4, add 2.5 to AG
            let correctedAG = AG;
            if (Alb < 4.0) {
                correctedAG = AG + (2.5 * (4.0 - Alb));
            }
            document.getElementById('resCorrAG').innerText = correctedAG.toFixed(1);

            // Interpretation
            const isHAGMA = correctedAG > 12;
            let deltaMsg = "";
            let tripleDisorder = false;

            if (isHAGMA) {
                // Calculate Delta Ratio
                // Delta Gap = AG - 12
                // Delta HCO3 = 24 - HCO3
                const deltaGap = correctedAG - 12;
                const deltaHCO3 = 24 - HCO3;
                
                // Avoid division by zero
                let ratio = 0;
                if (deltaHCO3 === 0) ratio = 999; // effectively infinity (pure metabolic alkalosis masking)
                else ratio = deltaGap / deltaHCO3;
                
                document.getElementById('resDelta').innerText = ratio.toFixed(2);
                
                // Delta Interpretation
                if (ratio < 0.4) {
                    deltaMsg = "Ratio < 0.4: HAGMA + Normal AG Metabolic Acidosis (NAGMA).";
                } else if (ratio >= 0.4 && ratio <= 0.8) {
                    deltaMsg = "Ratio 0.4-0.8: HAGMA + NAGMA.";
                } else if (ratio > 0.8 && ratio <= 2.0) {
                    deltaMsg = "Ratio 0.8-2.0: Pure HAGMA.";
                } else if (ratio > 2.0) {
                    deltaMsg = "Ratio > 2.0: HAGMA + Metabolic Alkalosis (or Pre-existing High Bicarb).";
                    tripleDisorder = true; // Potential triple if Resp disorder also exists
                }

                document.getElementById('deltaInterp').innerHTML = `<strong>HAGMA Detected.</strong><br>${deltaMsg}`;

                // Triple Disorder Check logic
                // If we found HAGMA + Met Alk (via Delta) AND we have a Respiratory Disorder found earlier
                if (tripleDisorder && (isRespAcid || isRespAlk)) {
                    document.getElementById('deltaInterp').innerHTML += `<br><strong style="color:var(--danger)">TRIPLE DISORDER SUSPECTED</strong> (Resp Disorder + HAGMA + Met Alkalosis).`;
                }

            } else {
                document.getElementById('resDelta').innerText = "N/A";
                document.getElementById('deltaInterp').innerHTML = "Anion Gap is Normal. (No HAGMA)";
            }

        } else {
            elAGSec.classList.add('hidden');
        }
    }
</script>

</body>
</html>
