<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced BGA Interpreter</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
        }
        
        /* Input Section */
        .section-title {
            background-color: var(--primary);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .parse-btn {
            background-color: var(--success);
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .parse-btn:hover { opacity: 0.9; }

        /* Manual Input Grid */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .input-wrapper { display: flex; flex-direction: column; }
        .input-wrapper label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        .input-wrapper input {
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        /* Results */
        .result-box {
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        .result-row:last-child { border-bottom: none; }
        .res-label { font-weight: 500; color: #555; }
        .res-val { font-weight: bold; color: var(--primary); }
        .res-note { font-size: 0.85rem; color: #7f8c8d; font-style: italic; display: block; margin-top: 2px;}

        .interpretation-main {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            padding: 10px;
            background: #e8f4fc;
            border-left: 5px solid var(--accent);
            border-radius: 4px;
            margin-bottom: 15px;
        }

        details {
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        summary {
            background: var(--light);
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .mnemonic-content {
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
            background: white;
        }
        ul { margin: 0; padding-left: 20px; }
        
        /* Status Colors */
        .acid { color: var(--danger); }
        .alk { color: var(--primary); }
        .normal { color: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <h1>Advanced BGA Interpreter</h1>

    <div class="controls">
        <div class="toggle-btn active" id="btnAcute" onclick="setChronicity('acute')">Acute</div>
        <div class="toggle-btn" id="btnChronic" onclick="setChronicity('chronic')">Chronic</div>
    </div>
    <div class="controls">
        <div class="toggle-btn active" id="btnAlbNorm" onclick="setAlbuminState('normal')">Albumin â‰¥ 4</div>
        <div class="toggle-btn" id="btnAlbLow" onclick="setAlbuminState('low')">Albumin &lt; 4</div>
    </div>

    <div class="section-title">1. Paste BGA (CSV / Text)</div>
    <textarea id="rawInput" placeholder="INSTRUKSI: Copas BGA dari EMR ke ChatGPT atau Gemini dengan prompt : convert these into CSV format, in CODEBLOCK. No * and # lalu copas hasilnya kesini. EMR -> AI -> FORM INI"></textarea>
    <button class="parse-btn" onclick="processInput()">Analyze Blood Gas</button>

    <div class="section-title">2. Verify Values</div>
    <div class="input-grid">
        <div class="input-wrapper"><label>pH</label><input type="number" step="0.01" id="in_pH" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>PaCO2 (mmHg)</label><input type="number" step="0.1" id="in_pco2" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>HCO3 (Input)</label><input type="number" step="0.1" id="in_hco3" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>HCO3 (Calc Act)</label><input type="number" step="0.1" id="calc_hco3" readonly style="background:#eee; color:#7f8c8d;"></div>
        <div class="input-wrapper"><label>Na+ (mEq/L)</label><input type="number" step="0.1" id="in_na" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>Cl- (mEq/L)</label><input type="number" step="0.1" id="in_cl" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>Albumin (g/dL)</label><input type="number" step="0.1" id="in_alb" value="4.0" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>Lactate (mmol/L)</label><input type="number" step="0.1" id="in_lac" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>PaO2 (mmHg)</label><input type="number" step="0.1" id="in_po2" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>FiO2 (0.21-1.0)</label><input type="number" step="0.01" id="in_fio2" value="0.21" oninput="runCalc()"></div>
        <div class="input-wrapper"><label>Base Excess (BE)</label><input type="number" step="0.1" id="in_be" oninput="runCalc()"></div>
    </div>

    <div class="section-title">3. Interpretation</div>
    
    <div id="interpretationBox" class="interpretation-main">Waiting...</div>

    <div class="result-box">
        <h4>Extracted Parameters</h4>
        <div class="result-row"><span class="res-label">pH Status</span><span id="out_ph_status" class="res-val">-</span></div>
        <div class="result-row"><span class="res-label">PaO2 / FiO2 Ratio</span><span id="out_pf_ratio" class="res-val">-</span></div>
        <div class="result-row"><span class="res-label">Calculated Anion Gap</span><span id="out_ag" class="res-val">-</span></div>
        <div class="result-row"><span class="res-label">Corrected AG</span><span id="out_ag_corr" class="res-val">-</span></div>
        <div class="result-row"><span class="res-label">Delta Ratio</span><span id="out_delta" class="res-val">-</span></div>
    </div>

    <div class="result-box">
        <h4>Detailed Analysis</h4>
        <div id="compAnalysis"><div class="res-note">Analysis will appear here.</div></div>
    </div>

    <details id="mnem_nagma">
        <summary>Normal Anion Gap Metabolic Acidosis (USED CARP)</summary>
        <div class="mnemonic-content">
            <ul>
                <li><strong>U</strong> - Uretero-sigmoidostomy</li>
                <li><strong>S</strong> - Saline (Hyperchloremic)</li>
                <li><strong>E</strong> - Endocrine (Addison's)</li>
                <li><strong>D</strong> - Diarrhea / GI Losses</li>
                <li><strong>C</strong> - Carbonic Anhydrase Inhibitors</li>
                <li><strong>A</strong> - Ammonium Chloride / TPN</li>
                <li><strong>R</strong> - Renal Tubular Acidosis</li>
                <li><strong>P</strong> - Pancreatic Fistula</li>
            </ul>
        </div>
    </details>
</div>

<script>
    let isChronic = false;
    let isLowAlbumin = false;

    function setChronicity(type) {
        isChronic = (type === 'chronic');
        document.getElementById('btnAcute').className = isChronic ? 'toggle-btn' : 'toggle-btn active';
        document.getElementById('btnChronic').className = isChronic ? 'toggle-btn active' : 'toggle-btn';
        runCalc();
    }

    function setAlbuminState(type) {
        isLowAlbumin = (type === 'low');
        document.getElementById('btnAlbNorm').className = isLowAlbumin ? 'toggle-btn' : 'toggle-btn active';
        document.getElementById('btnAlbLow').className = isLowAlbumin ? 'toggle-btn active' : 'toggle-btn';
        const albInput = document.getElementById('in_alb');
        if(isLowAlbumin && parseFloat(albInput.value) >= 4) albInput.value = "3.0";
        if(!isLowAlbumin && parseFloat(albInput.value) < 4) albInput.value = "4.0";
        runCalc();
    }

    function processInput() {
        const text = document.getElementById('rawInput').value;
        if (!text) return;
        const lines = text.split(/\r?\n/);
        const found = {};

        lines.forEach(line => {
            const parts = line.split(/[,:\t]/);
            if (parts.length < 2) return;
            const key = parts[0].trim().toLowerCase();
            const val = parseFloat(parts[1].trim());
            if (isNaN(val)) return;

            // Updated Parsing Logic
            if (key === 'ph') found.ph = val;
            else if (key === 'pco2' || key === 'paco2') found.pco2 = val;
            else if (key.includes('hco3')) found.hco3 = val;
            else if (key.startsWith('na')) found.na = val;
            else if (key.startsWith('cl')) found.cl = val;
            else if (key.includes('albumin')) found.alb = val;
            else if (key.includes('lactat')) found.lac = val;
            else if ((key === 'po2' || key === 'pao2')) found.po2 = val;
            else if (key.includes('fio2')) found.fio2 = val;
            // BE Priority
            else if (key === 'be') found.be = val;
            else if (key === 'beecf' && found.be === undefined) found.be = val;
        });

        if(found.ph !== undefined) document.getElementById('in_pH').value = found.ph;
        if(found.pco2 !== undefined) document.getElementById('in_pco2').value = found.pco2;
        if(found.hco3 !== undefined) document.getElementById('in_hco3').value = found.hco3;
        if(found.na !== undefined) document.getElementById('in_na').value = found.na;
        if(found.cl !== undefined) document.getElementById('in_cl').value = found.cl;
        if(found.alb !== undefined) document.getElementById('in_alb').value = found.alb;
        if(found.lac !== undefined) document.getElementById('in_lac').value = found.lac;
        if(found.po2 !== undefined) document.getElementById('in_po2').value = found.po2;
        if(found.be !== undefined) document.getElementById('in_be').value = found.be;

        if(found.fio2 !== undefined) {
            let f = found.fio2;
            if(f > 1) f = f / 100;
            document.getElementById('in_fio2').value = f;
        }
        if (found.alb !== undefined) {
            if (found.alb < 4.0) setAlbuminState('low'); else setAlbuminState('normal');
        }
        runCalc();
    }

    function runCalc() {
        const val = (id) => {
            const el = document.getElementById(id);
            return el && el.value ? parseFloat(el.value) : null;
        };

        const pH = val('in_pH');
        const pCO2 = val('in_pco2');
        let InputHCO3 = val('in_hco3');
        const Na = val('in_na');
        const Cl = val('in_cl');
        const Alb = val('in_alb') || 4.0;
        const PaO2 = val('in_po2');
        const FiO2 = val('in_fio2');
        const BE = val('in_be');

        // --- 1. Calculate Actual HCO3 (Henderson-Hasselbalch) ---
        // Helpful when input is Standard Bicarb (st) which masks respiratory compensation
        let UsedHCO3 = InputHCO3;
        let CalcHCO3 = null;
        if (pH && pCO2) {
            // HCO3 = 0.03 * pCO2 * 10^(pH - 6.1)
            CalcHCO3 = 0.03 * pCO2 * Math.pow(10, (pH - 6.1));
            document.getElementById('calc_hco3').value = CalcHCO3.toFixed(1);
            
            // Logic to prefer Calculated if Input looks like Standard Bicarb (usually ~24)
            // Or if input is missing
            if (InputHCO3 === null) {
                UsedHCO3 = CalcHCO3;
            } else if (Math.abs(InputHCO3 - CalcHCO3) > 2) {
                // Large discrepancy suggests Input might be Standard Bicarb
                // For compensation calc, Actual (Calc) is better.
                // However, let's stick to input unless it breaks things, 
                // but for your specific case, let's lean on Calc for checking compensation
            }
        }

        // --- 2. pH Status ---
        let pHStatus = "Normal";
        if (pH < 7.35) pHStatus = "Acidemia";
        else if (pH > 7.45) pHStatus = "Alkalemia";
        
        const elPh = document.getElementById('out_ph_status');
        elPh.innerText = pHStatus;
        elPh.className = "res-val " + (pHStatus === "Normal" ? "normal" : (pHStatus === "Acidemia" ? "acid" : "alk"));

        if (PaO2 && FiO2) {
            const pf = (PaO2 / FiO2).toFixed(0);
            document.getElementById('out_pf_ratio').innerText = pf + (pf < 300 ? " (ALI/ARDS)" : "");
        }

        // --- 3. Primary Disorder Identification ---
        // Using "UsedHCO3" (Input) for definitions usually, but let's be smart.
        
        let isMetAcid = false;
        let isMetAlk = false;
        let isRespAcid = (pCO2 !== null && pCO2 > 45);
        let isRespAlk = (pCO2 !== null && pCO2 < 35);
        let isHyperChlor = (Cl !== null && Cl > 106);

        // Smart Met Acid Detection
        if (UsedHCO3 !== null && UsedHCO3 < 22) isMetAcid = true;
        // CRITICAL FIX: If Acidemic + Negative BE, it's Met Acid even if HCO3 is normal (Relative Deficit)
        else if (pH < 7.35 && BE !== null && BE < -2) isMetAcid = true;
        
        if (UsedHCO3 !== null && UsedHCO3 > 26) isMetAlk = true;

        let primaryDx = [];
        if (pHStatus === "Acidemia") {
            if (isRespAcid && isMetAcid) primaryDx.push("Mixed Respiratory & Metabolic Acidosis");
            else if (isRespAcid) primaryDx.push("Respiratory Acidosis");
            else if (isMetAcid) primaryDx.push("Metabolic Acidosis");
        } else if (pHStatus === "Alkalemia") {
            if (isRespAlk && isMetAlk) primaryDx.push("Mixed Respiratory & Metabolic Alkalosis");
            else if (isRespAlk) primaryDx.push("Respiratory Alkalosis");
            else if (isMetAlk) primaryDx.push("Metabolic Alkalosis");
        } else {
            // Normal pH
            if (isRespAcid && isMetAlk) primaryDx.push("Mixed Resp. Acidosis & Met. Alkalosis");
            else if (isRespAlk && isMetAcid) primaryDx.push("Mixed Resp. Alkalosis & Met. Acidosis");
            else if (isMetAcid) primaryDx.push("Compensated Metabolic Acidosis"); // Hidden
            else primaryDx.push("Normal Acid-Base Status");
        }

        // --- 4. Compensation & Hidden Disorders ---
        let compHTML = "";
        
        // Respiratory Acidosis Compensation Check
        if (isRespAcid && UsedHCO3 !== null) {
            let expHCO3 = 24;
            let disorderStr = isChronic ? "Chronic" : "Acute";
            let deltaP = pCO2 - 40;
            
            // Formula
            if (isChronic) expHCO3 = 24 + (4 * (deltaP / 10));
            else expHCO3 = 24 + (1 * (deltaP / 10)); // Acute = 1 for 10
            
            let min = expHCO3 - 2;
            let max = expHCO3 + 2;

            compHTML += `<p><strong>${disorderStr} Resp. Acidosis:</strong> Exp HCO3 ${min.toFixed(1)}-${max.toFixed(1)}.<br>`;
            
            // Strict check using BE for tie-breaking
            if (UsedHCO3 < min) {
                compHTML += `<span class="acid">Concomitant Metabolic Acidosis</span> (HCO3 too low).`;
                if(!primaryDx.some(d => d.includes("Metabolic Acidosis"))) primaryDx.push("Concomitant Met. Acidosis");
            } 
            else if (UsedHCO3 >= min && UsedHCO3 <= max) {
                // It fits the range, BUT check BE/Chloride for hidden NAGMA
                if (BE !== null && BE < -2.5) {
                     compHTML += `<span class="acid">Concomitant Metabolic Acidosis</span> (Detected by Base Excess < -2.5).`;
                     if(!primaryDx.some(d => d.includes("Metabolic Acidosis"))) primaryDx.push("Concomitant Met. Acidosis");
                } else {
                    compHTML += `Appropriate Compensation.`;
                }
            } 
            else if (UsedHCO3 > max) {
                compHTML += `<span class="alk">Concomitant Metabolic Alkalosis</span> (HCO3 too high).`;
                if(!primaryDx.some(d => d.includes("Metabolic Alkalosis"))) primaryDx.push("Concomitant Met. Alkalosis");
            }
            compHTML += `</p>`;
        }

        document.getElementById('compAnalysis').innerHTML = compHTML;

        // --- 5. Anion Gap & Delta ---
        let agVal = "-";
        let agCorr = "-";
        let deltaRatio = "-";
        let isHAGMA = false;

        if (Na && Cl && UsedHCO3) {
            const ag = Na - (Cl + UsedHCO3);
            agVal = ag.toFixed(1);
            
            let corrAG = ag;
            if (Alb < 4.0) corrAG = ag + (2.5 * (4.0 - Alb));
            agCorr = corrAG.toFixed(1);

            if (corrAG > 12) {
                isHAGMA = true;
                // Update diagnosis
                primaryDx = primaryDx.map(d => d.replace("Metabolic Acidosis", "HAGMA"));
                if(!primaryDx.some(d => d.includes("HAGMA"))) primaryDx.push("HAGMA");
            } 
            else if (primaryDx.some(d => d.includes("Metabolic Acidosis")) || isHyperChlor) {
                // If Met Acid is present but AG is normal -> NAGMA
                primaryDx = primaryDx.map(d => d.replace("Metabolic Acidosis", "NAGMA"));
                if(!primaryDx.some(d => d.includes("NAGMA"))) primaryDx.push("NAGMA");
            }

            // Delta Ratio
            if (isHAGMA) {
                const num = corrAG - 12;
                const den = 24 - UsedHCO3;
                if (den <= 0) deltaRatio = "> 2.0";
                else {
                    const ratio = num / den;
                    deltaRatio = ratio.toFixed(2);
                    if(ratio < 0.4 || ratio < 0.8) primaryDx.push("Concomitant NAGMA (Delta < 0.8)");
                    else if(ratio > 2.0) primaryDx.push("Concomitant Met. Alkalosis (Delta > 2.0)");
                }
            }
        }

        document.getElementById('out_ag').innerText = agVal;
        document.getElementById('out_ag_corr').innerText = agCorr;
        document.getElementById('out_delta').innerText = deltaRatio;

        // Final Display
        if (primaryDx.length === 0) primaryDx.push("Normal");
        // Remove duplicates
        let uniqueDx = [...new Set(primaryDx)];
        document.getElementById('interpretationBox').innerText = uniqueDx.join(" + ");
    }
</script>

</body>
</html>

